<!doctype html><html lang=en><head><title>Ascensia ContourUSB Python driver :: arvchristos — Personal web corner</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Introduction I have used numerous glucose meters the last 20 years, but only lately I found interest in exporting statistics about my blood glucose levels. Most of the models provide a proprietary exporting tool that is AFAIK only for Windows. However, down to the connection interface level, all those devices use either USB or Serial connection. This fact led to the development of many libraries meant to interface and provide data export functionality for a number of devices, regardless of the underlying operating system."><meta name=keywords content><meta name=robots content=noodp><link rel=canonical href=/project/contourusb/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><meta name=twitter:card content=summary><meta name=twitter:title content="Ascensia ContourUSB Python driver"><meta name=twitter:description content="Python driver implementation for Ascensia ContourUSB glucose meter."><meta property=og:title content="Ascensia ContourUSB Python driver"><meta property=og:description content="Python driver implementation for Ascensia ContourUSB glucose meter."><meta property=og:type content=article><meta property=og:url content=/project/contourusb/><meta property=article:published_time content=2019-09-25T00:00:00+00:00><meta property=article:modified_time content=2019-09-25T00:00:00+00:00><meta property=og:site_name content=arvchristos></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44" class="greater-icon"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>@arvchristos</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a class=active href=/projects>Projects</a></li><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/projects>Projects</a></li><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22 3 32.4934 11.5066 41 22 41zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h2 class=post-title><a href=/project/contourusb/>Ascensia ContourUSB Python driver</a></h2><div class=post-meta><span class=post-date>2019-09-25</span>
<span class=post-tags>#<a href=/tags/driver/>driver</a>&nbsp;
#<a href=/tags/open_source/>open_source</a>&nbsp;
#<a href=/tags/python/>python</a>&nbsp;</span></div><div class=post-content><p><img src=/images/uploads/contourusb.jpg alt></p><h2 id=introduction>Introduction</h2><p>I have used numerous glucose meters the last 20 years, but only lately I found interest in exporting statistics about my blood glucose levels. Most of the models provide a proprietary exporting tool that is AFAIK only for Windows. However, down to the connection interface level, all those devices use either USB or Serial connection. This fact led to the development of many libraries meant to interface and provide data export functionality for a number of devices, regardless of the underlying operating system. The most famous library of that kind is <a href=https://github.com/Flameeyes/glucometerutils>glucometerutils</a> by <a href=https://github.com/Flameeyes>@Flameeyes</a>, implemented in Python.</p><p><code>glucometerutils</code> already supports multiple manufacturers device. However, when I wanted to export readings from my Ascensia (formerly Bayer) ContourUSB meter I realized that no one had implemented the required module for <code>glucometerutils</code>. Having used this library for my Freestyle Libre, I already had my graph scripts ready to get data in this particular format. So I decided to write the driver myself.</p><h2 id=requirements>Requirements</h2><p>The library already provides a common interface for all the meters. Specifically, varying by device, the supported functionality is outlined by the following commands:</p><pre><code>* info - get info about device (e.g., software version, serial number)
* dump - extract all readings in specified format
* datetime - get or set datetime on meter
* zero - flush meter memory
</code></pre><p>The current implementation of ContourUSB driver only implements info and dump. However the rest of the commands are to be implemented in the future.</p><h2 id=contourusb-protocol>ContourUSB protocol</h2><p>Implementing a device driver from the ground up requires knowledge of the underlying communication protocol and this knowledge is <em>almost</em> never open and accessible. Every device has its own protocol commands and conventions, making it difficult to create a universal supporting software, hence developers end up sniffing communication data while using the proprietary software provided by the manufacturer and reverse engineering the command set. In fact, @Flameeyes has created a <a href=https://protocols.glucometers.tech>separate repository</a> where he tracks protocol details about all devices he, or other contributors, reverse engineered for <code>glucometerutils</code> driver implementations.</p><p>Fortunately, for Ascensia meters, Bayer decided that the possibilities that will arise by opening protocol details are far more than the commercial problems for the company. Protocol details are accessible for everyone at <a href=http://protocols.ascensia.com/Programming-Guide.aspx>Ascensia developer website</a>, so we will not spend any time describing the protocol used.</p><h2 id=implementation>Implementation</h2><p>ContourUSB is recognized as a simple <code>hidraw</code> device and the pseudo-file <code>/dev/hidraw*</code> is used for read/write of data.Communication between host and glucose meter is based on frames of standard format. Those frames are byte strings and we use regular expressions to extract needed fields.</p><h3 id=info><code>info</code></h3><p>ContourUSB provides device information via specific frames called <code>Header records</code> in standardized format. Among others, details include:</p><ul><li>Serial number</li><li>Software version</li><li>Measurement unit used</li><li>Date and Time of meter</li><li>Total records stored in meter memory</li><li>Blood glucose ranges set by manufacturer/user</li><li>Meter language</li></ul><p><a href=https://github.com/Flameeyes/glucometerutils/blob/d258a6813aa26b94b160374823f5498370e3358d/glucometerutils/support/contourusb.py#L194>This code segment</a> stores Header record data for use in the info command.</p><h3 id=dump><code>dump</code></h3><p>ContourUSB exports all stored reading records in the so called <code>Download mode</code>. During this mode, readings are encapsuled in frames that include a checksum for validation checks, the reading value, its timestamp and any supplementary info such as labels about the reading. My implementation was based on <a href=https://bitbucket.org/iko/glucodump/src/default/>this</a> repository that gets the meter to download mode and then reads each frame following while checking their checksums for validation. Each frame is parsed using the corresponding regular expression object and then provides (or better yields) data to the higher level functions of the driver for standard driver functionality.
For more info consult the <a href=https://github.com/Flameeyes/glucometerutils/blob/d258a6813aa26b94b160374823f5498370e3358d/glucometerutils/support/contourusb.py#L311>corresponding code segment</a>.</p><h2 id=conclusion>Conclusion</h2><p>The driver implementation is included in the following commit:</p><ul><li><a href=https://github.com/Flameeyes/glucometerutils/commit/48e89e53d9983312e36ae6c353da9b94fa46b590>Add driver implementation for Ascensia ContourUSB.</a></li></ul><p>that was merged in the master branch of <code>glucometerutils</code>.</p><h2 id=future-work>Future work</h2><p>Implementation of remote code functionality, provided by the protocol documentation, such as datetime set and memory flush is pending.</p><h2 id=acknowledgements>Acknowledgements</h2><p>The following people contributed valuable information for this project:
* Anders Hammarquist for <a href=https://bitbucket.org/iko/glucodump/src/default/>glucodump</a>
* Alexander Schrijver
for the driver outline and communication functions included in his previous try for the same device.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other projects</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/project/virtio_paravirt_crypto_char_device/><span class=button__text>VirtIO Paravirtualized cryptographic character device for QEMU-KVM</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44" class="greater-icon"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>@arvchristos</span>
<span class=logo__cursor></span></a><div class=copyright><span>Developed by <a href=https://www.linkedin.com/in/arvchristos/ target=_blank rel=noopener>arvchristos</a></span>
<span>© 2020 Powered by <a href=https://opensource.org/ target=_blank rel=noopener>Open Source Software</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script><script src=/assets/fontawesome.js crossorigin=anonymous></script><script>if(window.netlifyIdentity){window.netlifyIdentity.on("init",user=>{if(!user){window.netlifyIdentity.on("login",()=>{document.location.href="/admin/";});}});}</script></div></body></html>